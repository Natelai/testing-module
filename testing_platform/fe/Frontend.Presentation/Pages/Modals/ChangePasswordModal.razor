@using Contracts.APICommunication
@using Frontend.Presentation.Services
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject AuthService AuthService
@inject NavigationManager NavigationManager

<RadzenTemplateForm TItem="ChangePasswordRequest" Data=@_request class="login-card" Submit="OnSubmit">
    <RadzenCard>
        <RadzenStack Style="width: 100%" Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
            <RadzenButton Icon="close" Click="() => DialogService.Close()"
                          IconColor="#000000" Style="background-color: transparent; box-shadow: none"/>
        </RadzenStack>
    
        <RadzenText Style="width: 100%;text-align: center;color:#1e1e1e;font-size: 1.5rem;font-weight: 400" Text="Change Password" />
    
        <RadzenStack Style="margin-top: 30px" Gap="15px">
            <RadzenStack Style="width: 100%" JustifyContent="JustifyContent.SpaceBetween" Orientation="Orientation.Horizontal">
                <RadzenText Text="Current Password:" Style="font-size: 1.2rem;font-weight: 400;display: flex;align-items: center;" />
                <RadzenFormField Variant="Variant.Flat">
                    <ChildContent>
                        <RadzenTextBox Style="padding: 10px" @bind-Value="_request.OldPassword" Visible="@(_showPassword)"
                                       Name="Password" />
                        <RadzenPassword Style="padding: 10px" @bind-Value="_request.OldPassword" Name="PasswordHide" Visible="@(!_showPassword)" />
                    </ChildContent>
                </RadzenFormField>
            </RadzenStack>
            <RadzenRegexValidator Component="Password" Text="Password is not valid" 
                                  Pattern="^(?=.*[0-9])(?=.*[A-Z])(?=.*[!#$%^:\\|,.<>\\/?]).{8,}$" />
        
            <RadzenStack Style="width: 100%" JustifyContent="JustifyContent.SpaceBetween" Orientation="Orientation.Horizontal">
                <RadzenText Text="New Password": Style="font-size: 1.2rem;font-weight: 400;display: flex;align-items: center;" />
                <RadzenFormField Variant="Variant.Flat">
                    <ChildContent>
                        <RadzenTextBox Style="padding: 10px" @bind-Value="_request.NewPassword" Visible="@(_showPassword)"
                                       Name="NewPassword" />
                        <RadzenPassword Style="padding: 10px" @bind-Value="_request.NewPassword" Name="NewPasswordHide" Visible="@(!_showPassword)" />
                    </ChildContent>
                </RadzenFormField>
            </RadzenStack>
            <RadzenRegexValidator Component="NewPassword" Text="Password is not valid"
                                  Pattern="^(?=.*[0-9])(?=.*[A-Z])(?=.*[!#$%^:\\|,.<>\\/?]).{8,}$" />
        
            <RadzenStack Style="width: 100%" JustifyContent="JustifyContent.SpaceBetween" Orientation="Orientation.Horizontal">
                <RadzenText Text="Confirm password:" Style="font-size: 1.2rem;font-weight: 400;display: flex;align-items: center;" />
                <RadzenFormField Variant="Variant.Flat">
                    <ChildContent>
                        <RadzenTextBox Style="padding: 10px" @bind-Value="_confirmPassword" Visible="@(_showPassword)"
                                       Name="ConfirmPassword" />
                        <RadzenPassword Style="padding: 10px" @bind-Value="_confirmPassword" Name="PasswordHide" Visible="@(!_showPassword)" />
                    </ChildContent>
                </RadzenFormField>
            </RadzenStack>
            <RadzenCompareValidator Visible=@(!string.IsNullOrEmpty(_confirmPassword))
                                    Value=@_request.NewPassword Component="ConfirmPassword" Text="Passwords should be the same" />
        </RadzenStack>

        <RadzenStack Style="height:16px;margin-top: 5px" Orientation="Orientation.Horizontal">
            <RadzenCheckBox @bind-Value="_showPassword"></RadzenCheckBox>
            <RadzenText Text="Show password" Style="font-size:14px" />
        </RadzenStack>

        <RadzenStack Style="width: 100%;margin-top: 20px" Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center">
            <RadzenButton Style="width: 200px;height:50px;border-radius: 30px;background-color: #34c759;color:#000000"
                          ButtonType="ButtonType.Submit">Save</RadzenButton>
        </RadzenStack>
    </RadzenCard>
</RadzenTemplateForm>


@code {
    
    private bool _showPassword;

    private ChangePasswordRequest _request = new();

    private string _confirmPassword = string.Empty;

    private async Task OnSubmit()
    {
        var rsp = await AuthService.ChangePasswordAsync(_request.OldPassword, _request.NewPassword);

        if (rsp)
        {
            NotificationService.Notify(
                new NotificationMessage
                {
                    Severity = NotificationSeverity.Success, 
                    Summary = "Password changed"
                });

            await AuthService.Logout();
            NavigationManager.NavigateTo("/login");

            return;
        }

        NotificationService.Notify(
            new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Request failed"
                });
    }
}
